<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="carrera-titulo-head">Cargando Carrera...</title> 
    <link rel="stylesheet" href="Estilos/estilos.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
</head>
<body>

<header class="header">
    <div class="header-left">
        <a href="index.html" class="logo-link">
            <img src="Multimedia/logo_IES 6.png" alt="Logo IES-6" class="logo">
        </a>
    </div>
    
    <button class="menu-toggle">
        <i class="fas fa-bars"></i> 
    </button>
    
    <nav class="nav">
        <ul>
            <li><a href="index.html" class="login-btn">Inicio</a></li>
            <li class="dropdown" id="carreras-menu-item">
                <a href="#" class="login-btn dropdown-btn" id="carreras-dropdown-button">Carreras</a>
                <ul class="dropdown-content" id="carreras-dropdown">
                </ul>
            </li>
            <li><a href="mi-horario.html" class="login-btn">Mi Horario</a></li>
            <li class="dropdown" id="contacto-menu-item">
                <a href="#" class="login-btn dropdown-btn" id="contacto-dropdown-button">Contacto</a>
                <ul class="dropdown-content" id="contacto-dropdown">
                    <li><a href="https://wa.me/5493885050885" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a></li>
                    <li><a href="mailto:ismaelangel022@gmail.com"><i class="fas fa-envelope"></i> Correo ElectrÃ³nico</a></li>
                    <li><a href="tel:+5493885050885"><i class="fas fa-phone"></i> TelÃ©fono</a></li>
                    <li><a href="https://facebook.com/ismael.hoyos.9" target="_blank"><i class="fab fa-facebook"></i> Facebook</a></li>
                    <li><a href="https://instagram.com/ismael.hoyos.9" target="_blank"><i class="fab fa-instagram"></i> Instagram</a></li>
                </ul>
            </li>
            <li><a href="acceso.html" class="login-btn">Acceder</a></li>
        </ul>
    </nav>
</header>

    <main class="main-content">
        <div class="carrera-container">
            <section class="carrera-main">
                <h1 id="carrera-nombre">Cargando Nombre de Carrera...</h1>
                <p class="subtitulo" id="carrera-subtitulo"></p>

                <div class="imagen-carrera-superior">
                    <img id="imagen-principal" src="https://placehold.co/800x200/e9ecef/27374d?text=Cargando+Imagen" alt="Imagen representativa de la carrera" />
                </div>

                </section>

            <aside class="carrera-sidebar">
                <div class="caja-info">
                    <h3>InformaciÃ³n General ðŸ“š</h3>
                    <p><strong>DuraciÃ³n:</strong> <span id="duracion">Cargando...</span></p>
                    <p><strong>Modalidad:</strong> <span id="modalidad">Cargando...</span></p>
                    <p><strong>AÃ±o de AprobaciÃ³n Plan de Estudio:</strong> <span id="anio-aprobacion">Cargando...</span></p>
                    
                    <hr>
                    
                    <h4>CoordinaciÃ³n ðŸ‘¤</h4>
                    <p><strong>Coordinador:</strong> <span id="coordinador-nombre">Cargando...</span></p>
                    <p><strong>Email:</strong> <span id="coordinador-email">No disponible</span></p>
                    <p><strong>TelÃ©fono:</strong> <span id="coordinador-telefono">No disponible</span></p>

                </div>

                <div class="caja-info descarga-plan">
                    
                        <button id="btn-descargar-plan" class="btn-principal" disabled>
                            Descargar Plan de Estudio
                        </button>
                        <p id="download-loading" class="hidden" style="color: #007bff; margin-top: 5px; text-align: center;">
                            Generando y descargando, por favor espere...
                        </p>
                </div>

            </aside>
        </div>

        <section class="plan-estudio">
            <h2 class="seccion-titulo">Plan de Estudio</h2>
            <div id="contenedor-anios-plan">
                <p>Cargando Plan de Estudio...</p>
            </div>
        </section>

    </main>

    <footer class="footer">
        Â© 2025 IES NÂ°6 â€“ Proyecto de GestiÃ³n de Cursada
    </footer>

    <div class="floating-chatbot-container">
        <button id="chatbot-toggle" class="chatbot-toggle-button">
            <i class="fas fa-comment-dots"></i> 
        </button>

        <div id="chatbot-window" class="chatbot-window hidden">
            <div class="chatbot-header">
                Asistente Virtual IES NÂ°6 
                <button id="chatbot-close-btn" class="close-btn">&times;</button>
            </div>
            <div class="chatbot-messages" id="chatbot-messages">
                
            </div>
            <div class="chat-input-container">
                <input type="text" 
                       id="chat-input" 
                       placeholder="Escribe tu consulta...">
                <button id="chat-send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="Scripts/menu.js"></script>
    <script src="Scripts/chatbot.js"></script>

    <script>
        // ID de la carrera actual (globalmente disponible)
        let idCarreraActual = null;
        let duracionCarrera = 0; // AlmacenarÃ¡ la duraciÃ³n para usarla en la generaciÃ³n del Plan

        const CARRERA_IMAGENES = {
            "Profesorado en EducaciÃ³n Secundaria en InformÃ¡tica": "Multimedia/carreras/PESI.png",
            "Profesorado en EducaciÃ³n Secundaria en Ciencias de la AdministraciÃ³n": "Multimedia/carreras/PESCA.png",
            "Profesorado en EducaciÃ³n Secundaria en InglÃ©s": "Multimedia/carreras/PI.png",
            "Profesorado en EducaciÃ³n Secundaria en MatemÃ¡ticas": "Multimedia/carreras/PESM.png",
            "Tecnicatura Superior en Ciencia de Datos de Inteligencia Artificial": "multimedia/carreras/TSIA.png",
            "Tecnicatura Superior en GestiÃ³n de EnergÃ­as Renovables": "Multimedia/carreras/TSER.png",
            "Tecnicatura Superior en GestiÃ³n de Recursos HÃ­dricos": "Multimedia/carreras/TSRH.png",
Â Â Â Â Â Â Â Â };

        // FunciÃ³n para obtener el ID de la URL
        function getCarreraIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        /**
         * Genera dinÃ¡micamente los botones de los aÃ±os para el Plan de Estudio.
         * @param {number} duracion - El nÃºmero de aÃ±os que dura la carrera.
         */
        function generarSeccionPlanEstudio(duracion) {
            const contenedorAnios = document.getElementById('contenedor-anios-plan');
            contenedorAnios.innerHTML = ''; // Limpiar el mensaje de "Cargando..."
            
            // Textos descriptivos para los aÃ±os
            const textosAnios = {
                1: "Primer AÃ±o",
                2: "Segundo AÃ±o",
                3: "Tercer AÃ±o",
                4: "Cuarto AÃ±o",
                5: "Quinto AÃ±o" // Por si acaso hay carreras de 5 aÃ±os
            };

            for (let anio = 1; anio <= duracion; anio++) {
                const nombreAnio = textosAnios[anio] || `AÃ±o ${anio}`;

                const anioHTML = `
                    <div class="anio">
                        <button class="boton-anio" data-anio="${anio}">${nombreAnio} â–¾</button>
                        <div class="tarjetas desplegable-anio" id="materias-${anio}"> 
                          </div>
                    </div>
                `;
                contenedorAnios.innerHTML += anioHTML;
            }

            // DespuÃ©s de generar el HTML, re-adjuntar los event listeners a los nuevos botones
            adjuntarEventListenersAnios();
        }

        /**
         * Adjunta los listeners de click a todos los botones de los aÃ±os.
         */
        function adjuntarEventListenersAnios() {
    const botonesAnio = document.querySelectorAll('.boton-anio');
    botonesAnio.forEach(boton => {
        boton.addEventListener('click', async () => {
            const anio = boton.getAttribute('data-anio');
            const contenedorMaterias = boton.nextElementSibling;
            
            // 1. Alternar la clase SIEMPRE para que el desplegable se abra/cierre
            const isActivo = contenedorMaterias.classList.toggle('activo'); 

            // 2. SOLO cargar las materias si el desplegable se acaba de abrir (isActivo es true) 
            //    Y si el contenido aÃºn no ha sido cargado (innerHTML.trim() === '')
            if (isActivo && contenedorMaterias.innerHTML.trim() === '') {
                // El contenedor estÃ¡ activo y estÃ¡ vacÃ­o, Â¡cargamos!
                await cargarMaterias(anio, contenedorMaterias);
            }
            
            // Si el desplegable se cierra (isActivo es false), no hacemos nada con el contenido.
        });
    });
}

        // ==========================================================
        // 1. Carga del Detalle de la Carrera (ACTUALIZADA Y CORREGIDA)
        // ==========================================================
        async function cargarDetalleCarrera() {
            const id = getCarreraIdFromUrl();
            idCarreraActual = id;

            if (!id) {
                document.getElementById('carrera-nombre').textContent = "Error: ID de Carrera no especificado.";
                document.getElementById('carrera-titulo-head').textContent = "Error";
                console.error("No se encontrÃ³ el ID de la carrera en la URL.");
                return;
            }

            const url = `https://proyecto-cursado-backend.onrender.com/api/carreras/${id}`;

            try {
                const respuesta = await fetch(url);
                if (!respuesta.ok) {
                    throw new Error(`Error al cargar el detalle: ${respuesta.status}`);
                }
                const data = await respuesta.json();
                
                if (!data) {
                    document.getElementById('carrera-nombre').textContent = "Carrera no encontrada.";
                    return;
                }

                // 1. Actualizar TÃ­tulos
                document.getElementById('carrera-titulo-head').textContent = `${data.nombre_carrera} â€“ IES NÂ°6`;
                document.getElementById('carrera-nombre').textContent = data.nombre_carrera;
                document.getElementById('carrera-subtitulo').textContent = data.resolucion || '';

                // 2. Actualizar Aside / InformaciÃ³n General (Campos de Carrera)
                duracionCarrera = parseInt(data.duracion, 10); // Guardar la duraciÃ³n como nÃºmero
                const duracionTexto = duracionCarrera ? `${duracionCarrera} aÃ±os` : 'No especificada';

                document.getElementById('duracion').textContent = duracionTexto;
                document.getElementById('modalidad').textContent = data.modalidad || 'Presencial';
                document.getElementById('anio-aprobacion').textContent = data.aÃ±o_aprobacion || 'No especificado';
                
                // 3. Datos del Coordinador
                const coordinador = data.coordinador; 
                
                document.getElementById('coordinador-nombre').textContent = coordinador?.nombre_administrador || 'Pendiente';
                document.getElementById('coordinador-email').textContent = coordinador?.email || 'No disponible';
                document.getElementById('coordinador-telefono').textContent = coordinador?.telefono || 'No disponible';
                
                // 4. *** LÃ“GICA DE IMAGEN DINÃMICA ***
                const nombreCarreraNormalizado = data.nombre_carrera.trim();
                let urlImagen = CARRERA_IMAGENES[nombreCarreraNormalizado] || IMAGEN_DEFAULT;

                // Si el backend proporciona una URL de imagen, Ãºsala preferentemente (este es un campo hipotÃ©tico)
                if (data.url_imagen_principal) {
                    urlImagen = data.url_imagen_principal;
                }
                
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('imagen-principal').src = urlImagen;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('imagen-principal').alt = `Imagen representativa de ${data.nombre_carrera}`;
                
                // 5. Generar el Plan de Estudio dinÃ¡micamente
                if (duracionCarrera > 0) {
                    generarSeccionPlanEstudio(duracionCarrera);
                } else {
                     document.getElementById('contenedor-anios-plan').innerHTML = '<p>DuraciÃ³n de la carrera no disponible para cargar el Plan de Estudio.</p>';
                }

                // 6. *** CÃ“DIGO FALTANTE: HABILITAR BOTÃ“N DE DESCARGA Y ADJUNTAR LISTENER ***
                const downloadButton = document.getElementById('btn-descargar-plan');
                downloadButton.disabled = false;
                downloadButton.addEventListener('click', descargarPlanEstudioPDF);


            } catch (error) {
                console.error("Error al obtener el detalle de la carrera:", error);
                document.getElementById('carrera-nombre').textContent = "Error al conectar con el servidor.";
            }
        }

        // ==========================================================
Â  Â  Â  Â  // 2. Carga de Materias por AÃ±o
Â  Â  Â  Â  // ==========================================================
async function cargarMaterias(anio, contenedor) {
    
    if (!idCarreraActual) {
        contenedor.innerHTML = '<p>Error: ID de carrera no disponible.</p>';
        return;
    }

    // CORRECCIÃ“N FINAL:
    // 1. Definimos el nombre del parÃ¡metro como lo espera el servidor: 'aÃ±o'
    const parametroAnio = 'aÃ±o';
    
    // 2. Usamos encodeURIComponent() para asegurarnos de que el caracter 'Ã±'
    //    (o su codificaciÃ³n %C3%B1) sea manejado correctamente en la URL.
    //    La URL resultante serÃ¡: .../api/materias?id_carrera=X&%C3%B1o=Y
    const url = `https://proyecto-cursado-backend.onrender.com/api/materias?id_carrera=${idCarreraActual}&${encodeURIComponent(parametroAnio)}=${anio}`;

    contenedor.innerHTML = '<p>Cargando materias...</p>';

    try {
        const respuesta = await fetch(url);
        if (!respuesta.ok) {
            // Muestra el error de red o de servidor, pero no el mensaje que confunde.
            throw new Error(`Error en el servidor: ${respuesta.status}`); 
        }
        const materias = await respuesta.json();
        
        contenedor.innerHTML = '';
        contenedor.setAttribute('data-loaded', 'true'); // Marcar como cargado

        if (materias.length === 0) {
            contenedor.innerHTML = '<p style="padding: 1rem; text-align: center;">No se encontraron materias para este aÃ±o.</p>';
        } else {
            materias.forEach(materia => {
                const materiaHTML = `
                    <article class="tarjeta">
                        <div class="tarjeta__titulo">${materia.nombre_materia}</div>
                        <a class="boton-detalle" href="materia.html?id=${materia.id_materia}">Ver Detalle</a>
                    </article>
                `;
                contenedor.innerHTML += materiaHTML;
            });
        }
    } catch (error) {
        console.error("Error al obtener las materias:", error);
        // Quitamos el mensaje confuso sobre "anio" y ponemos uno genÃ©rico.
        contenedor.innerHTML = '<p style="padding: 1rem; text-align: center; color: red;">OcurriÃ³ un error al cargar las materias. Revise la consola para detalles del servidor.</p>';
        contenedor.setAttribute('data-loaded', 'false');
    }
}

// ==========================================================
Â  Â  Â  Â  Â  Â  Â  Â  // NUEVA FUNCIÃ“N: Descargar Plan de Estudio PDF
Â  Â  Â  Â  Â  Â  Â  Â  // ==========================================================
Â  Â  Â  Â  Â  Â  Â  Â  async function descargarPlanEstudioPDF() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!idCarreraActual) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("No hay ID de carrera disponible para descargar el plan.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const downloadButton = document.getElementById('btn-descargar-plan');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const loadingMessage = document.getElementById('download-loading');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Deshabilita el botÃ³n y muestra el mensaje de carga
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadButton.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingMessage.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Endpoint que tu servidor debe implementar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const urlDescarga = `https://proyecto-cursado-backend.onrender.com/api/carreras/${idCarreraActual}/plan-estudio-pdf`; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const respuesta = await fetch(urlDescarga);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!respuesta.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Error del servidor: ${respuesta.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Obtiene el nombre del archivo desde el encabezado (si el servidor lo proporciona)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const contentDisposition = respuesta.headers.get('Content-Disposition');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let filename = `Plan_Estudio_${idCarreraActual}.pdf`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (contentDisposition && contentDisposition.indexOf('filename=') !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  filename = contentDisposition.split('filename=')[1].replace(/"/g, '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Procesa la respuesta como un Blob (archivo binario)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const blob = await respuesta.blob();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Crea una URL temporal para el Blob
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const url = window.URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  a.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  a.href = url;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  a.download = filename; // Nombre del archivo a descargar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  a.click(); // Simula el click para iniciar la descarga
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.URL.revokeObjectURL(url); // Limpia la URL temporal

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error durante la descarga del Plan de Estudio:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('OcurriÃ³ un error al intentar descargar el plan de estudio. Por favor, revise que el servidor estÃ© funcionando y que el endpoint sea correcto.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Habilita el botÃ³n y oculta el mensaje de carga
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingMessage.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

        // ==========================================================
        // 3. InicializaciÃ³n
        // ==========================================================

        document.addEventListener('DOMContentLoaded', () => {
             cargarDetalleCarrera();
             // Nota: Los event listeners para los botones de aÃ±o se adjuntan
             // dentro de generarSeccionPlanEstudio una vez que se cargan los datos.
        });
    </script>
</body>
</html>